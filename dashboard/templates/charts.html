{% extends "base.html" %}

{% block content %}
<!-- Chart Controls -->
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-body">
        <div style="display: flex; gap: 2rem; align-items: center; flex-wrap: wrap;">
            <div>
                <strong>Symbol:</strong>
                <select id="symbolSelect" onchange="changeSymbol(this.value)">
                    <option value="EURUSD" {% if symbol == 'EURUSD' %}selected{% endif %}>EUR/USD</option>
                    <option value="GBPUSD" {% if symbol == 'GBPUSD' %}selected{% endif %}>GBP/USD</option>
                    <option value="USDJPY" {% if symbol == 'USDJPY' %}selected{% endif %}>USD/JPY</option>
                    <option value="XAUUSD" {% if symbol == 'XAUUSD' %}selected{% endif %}>XAU/USD</option>
                </select>
            </div>

            <div>
                <strong>Data Points:</strong>
                <select id="limitSelect" onchange="changeLimit(this.value)">
                    <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
                    <option value="200" {% if limit == 200 %}selected{% endif %}>200</option>
                    <option value="500" {% if limit == 500 %}selected{% endif %}>500</option>
                </select>
            </div>

            <div>
                <strong>Latest Price:</strong>
                <span class="metric-value" style="color: #3182ce;">
                    {{ "%.5f"|format(chart_data.latest_price) }}
                </span>
            </div>

            <button class="btn btn-sm" onclick="refreshChart()">ðŸ”„ Refresh</button>
        </div>
    </div>
</div>

<!-- Price Chart -->
<div class="card">
    <div class="card-header">
        {{ symbol }} Price Chart
        <span class="badge badge-info">{{ chart_data.count }} points</span>
    </div>
    <div class="card-body">
        <div id="priceChart" style="width: 100%; height: 500px;"></div>
    </div>
</div>

<!-- Chart Statistics -->
<div class="grid" style="margin-top: 2rem;">
    <div class="card">
        <div class="card-header">
            Price Statistics
        </div>
        <div class="card-body">
            {% set prices = chart_data.data_points | map(attribute='price') | list %}
            {% if prices %}
            <div class="metric">
                <span>High</span>
                <span class="metric-value status-healthy">{{ "%.5f"|format(prices | max) }}</span>
            </div>
            <div class="metric">
                <span>Low</span>
                <span class="metric-value status-error">{{ "%.5f"|format(prices | min) }}</span>
            </div>
            <div class="metric">
                <span>Range</span>
                <span class="metric-value">{{ "%.5f"|format((prices | max) - (prices | min)) }}</span>
            </div>
            <div class="metric">
                <span>Average</span>
                <span class="metric-value">{{ "%.5f"|format(prices | sum / prices | length) }}</span>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            Volume Statistics
        </div>
        <div class="card-body">
            {% set volumes = chart_data.data_points | map(attribute='volume') | list %}
            {% if volumes %}
            <div class="metric">
                <span>Total Volume</span>
                <span class="metric-value">{{ volumes | sum | int }}</span>
            </div>
            <div class="metric">
                <span>Average Volume</span>
                <span class="metric-value">{{ (volumes | sum / volumes | length) | int }}</span>
            </div>
            <div class="metric">
                <span>Max Volume</span>
                <span class="metric-value">{{ volumes | max | int }}</span>
            </div>
            <div class="metric">
                <span>Data Points</span>
                <span class="metric-value">{{ chart_data.count }}</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Chart data from backend
const chartData = {{ chart_data | tojson }};

// Function to render price chart
function renderChart() {
    if (!chartData.data_points || chartData.data_points.length === 0) {
        document.getElementById('priceChart').innerHTML =
            '<div style="display: flex; align-items: center; justify-content: center; height: 500px; color: #718096;">No data available</div>';
        return;
    }

    // Prepare data for Plotly
    const timestamps = chartData.data_points.map(d => new Date(d.timestamp));
    const prices = chartData.data_points.map(d => d.price);
    const volumes = chartData.data_points.map(d => d.volume);

    // Price trace (candlestick simulation with line chart)
    const priceTrace = {
        x: timestamps,
        y: prices,
        type: 'scatter',
        mode: 'lines+markers',
        name: '{{ symbol }} Price',
        line: {
            color: '#3182ce',
            width: 2
        },
        marker: {
            size: 4,
            color: '#2c5282'
        },
        hovertemplate:
            '<b>%{fullData.name}</b><br>' +
            'Time: %{x}<br>' +
            'Price: %{y:.5f}<br>' +
            '<extra></extra>'
    };

    // Volume trace
    const volumeTrace = {
        x: timestamps,
        y: volumes,
        type: 'bar',
        name: 'Volume',
        yaxis: 'y2',
        marker: {
            color: '#a0aec0',
            opacity: 0.6
        },
        hovertemplate:
            '<b>Volume</b><br>' +
            'Time: %{x}<br>' +
            'Volume: %{y}<br>' +
            '<extra></extra>'
    };

    const layout = {
        title: {
            text: '{{ symbol }} Price & Volume',
            font: { size: 16 }
        },
        xaxis: {
            title: 'Time',
            type: 'date'
        },
        yaxis: {
            title: 'Price',
            side: 'left',
            titlefont: { color: '#3182ce' },
            tickfont: { color: '#3182ce' }
        },
        yaxis2: {
            title: 'Volume',
            titlefont: { color: '#a0aec0' },
            tickfont: { color: '#a0aec0' },
            anchor: 'x',
            overlaying: 'y',
            side: 'right',
            showgrid: false
        },
        margin: { l: 50, r: 50, t: 50, b: 50 },
        plot_bgcolor: '#f7fafc',
        paper_bgcolor: '#ffffff',
        hovermode: 'x unified',
        showlegend: true,
        legend: {
            orientation: 'h',
            y: 1.02,
            x: 0
        }
    };

    const config = {
        responsive: true,
        displayModeBar: true,
        displaylogo: false,
        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
    };

    Plotly.newPlot('priceChart', [priceTrace, volumeTrace], layout, config);
}

// Navigation functions
function changeSymbol(newSymbol) {
    const currentUrl = new URL(window.location);
    currentUrl.pathname = `/charts/${newSymbol}`;
    currentUrl.searchParams.set('limit', '{{ limit }}');
    window.location.href = currentUrl.toString();
}

function changeLimit(newLimit) {
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('limit', newLimit);
    window.location.href = currentUrl.toString();
}

function refreshChart() {
    window.location.reload();
}

// Initialize chart when page loads
document.addEventListener('DOMContentLoaded', function() {
    renderChart();
});

// Style improvements for selects
document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('select');
    selects.forEach(select => {
        select.style.padding = '0.5rem';
        select.style.border = '1px solid #e2e8f0';
        select.style.borderRadius = '0.375rem';
        select.style.backgroundColor = 'white';
        select.style.fontSize = '0.875rem';
    });
});
</script>

<style>
.metric-value.status-healthy {
    color: #38a169;
}

.metric-value.status-error {
    color: #e53e3e;
}
</style>
{% endblock %}
